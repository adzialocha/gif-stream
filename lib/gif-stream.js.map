{"version":3,"file":"gif-stream.js","sources":["../src/utils/polyfill.js","../src/image.js","../src/upload.js","../src/stream.js"],"sourcesContent":["export default function getUserMediaPolyfill(constraints) {\n  const getUserMedia = (window.navigator.getUserMedia ||\n      window.navigator.webkitGetUserMedia ||\n      window.navigator.mozGetUserMedia ||\n      window.navigator.msGetUserMedia)\n\n  if (!getUserMedia) {\n    return Promise.reject(\n      new Error('getUserMedia is not implemented in this browser')\n    )\n  }\n\n  return new Promise((resolve, reject) => {\n    getUserMedia.call(window.navigator, constraints, resolve, reject)\n  })\n}\n","const DEFAULT_IMAGE_SIZE = 100\nconst IMAGE_QUALITY = 0.8\n\nconst canvas = document.createElement('canvas')\nconst context = canvas.getContext('2d')\n\nexport default function resizedVideostill(video, imageSize = DEFAULT_IMAGE_SIZE) {\n  const videoWidth = video.videoWidth\n  const videoHeight = video.videoHeight\n\n  if (!(videoWidth && videoHeight)) {\n    return 'data:image/jpeg;base64,'\n  }\n\n  canvas.width = imageSize\n  canvas.height = imageSize\n\n  const ratio = videoWidth / videoHeight\n  const targetWidth = imageSize + (imageSize / ratio / 2)\n  const targetHeight = imageSize\n  const xPos = videoWidth > videoHeight ? -(imageSize / ratio / 4) : 0\n  const yPos = videoWidth <= videoHeight ? -(imageSize / ratio / 4) : 0\n\n  context.drawImage(video, xPos, yPos, targetWidth, targetHeight)\n\n  return canvas.toDataURL('image/jpeg', IMAGE_QUALITY)\n}\n","function request(method = 'GET', url, data) {\n  return new Promise((resolve, reject) => {\n    const xhr = new XMLHttpRequest()\n    xhr.open(method, url)\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState === 4) {\n        if (xhr.status === 200) {\n          resolve(JSON.parse(xhr.responseText))\n        } else {\n          reject()\n        }\n      }\n    }\n    xhr.send(data)\n  })\n}\n\nexport default function signAndUploadFile(serverUrl, fileData, id) {\n  request('GET', `${serverUrl}/api/upload?id=${id}`)\n    .then((response) => {\n      request('PUT', response.signedUrl, fileData)\n    })\n}\n","import getUserMediaPolyfill from './utils/polyfill'\nimport resizedVideostill from './image'\nimport signAndUploadFile from './upload'\n\nconst defaultOptions = {\n  callback: () => {},\n  imageSize: 100,\n  interval: 10000,\n  serverUrl: 'http://localhost:3000',\n}\n\nfunction randomId() {\n  return Date.now().toString(36) + Math.random().toString(36).substr(2, 8)\n}\n\nclass GifStream {\n  constructor(customOptions) {\n    this.options = Object.assign({}, defaultOptions, customOptions)\n    this.video = document.createElement('video')\n\n    this.stream = null\n    this.intervalTask = null\n    this.sessionId = ''\n  }\n\n  handleNext() {\n    const imageData = resizedVideostill(this.video, this.options.imageSize)\n    signAndUploadFile(this.options.serverUrl, imageData, this.sessionId)\n\n    this.options.callback({\n      imageData,\n    })\n  }\n\n  start() {\n    if (this.intervalTask) {\n      return Promise.resolve()\n    }\n\n    const constraints = {\n      video: true,\n      audio: false,\n    }\n\n    return new Promise((resolve, reject) => {\n      getUserMediaPolyfill(constraints)\n        .then((stream) => {\n          this.stream = stream\n\n          try {\n            this.video.oncanplay = () => {\n              this.sessionId = randomId()\n              this.intervalTask = setInterval(() => {\n                this.handleNext()\n              }, this.options.interval)\n            }\n            this.video.src = window.URL.createObjectURL(this.stream)\n            this.video.play()\n\n            resolve()\n          } catch (error) {\n            reject(error)\n          }\n        })\n        .catch(reject)\n    })\n  }\n\n  stop() {\n    if (!this.intervalTask) {\n      return\n    }\n\n    const track = this.stream.getTracks()[0]\n    if (track) {\n      track.stop()\n    }\n\n    clearInterval(this.intervalTask)\n    this.intervalTask = null\n    this.sessionId = ''\n  }\n}\n\nexport default GifStream\n"],"names":["getUserMediaPolyfill","constraints","getUserMedia","window","navigator","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","Promise","reject","Error","resolve","call","DEFAULT_IMAGE_SIZE","IMAGE_QUALITY","canvas","document","createElement","context","getContext","resizedVideostill","video","imageSize","videoWidth","videoHeight","width","height","ratio","targetWidth","targetHeight","xPos","yPos","drawImage","toDataURL","request","method","url","data","xhr","XMLHttpRequest","open","onreadystatechange","readyState","status","JSON","parse","responseText","send","signAndUploadFile","serverUrl","fileData","id","then","response","signedUrl","defaultOptions","randomId","Date","now","toString","Math","random","substr","GifStream","customOptions","options","Object","assign","stream","intervalTask","sessionId","imageData","callback","oncanplay","setInterval","handleNext","interval","src","URL","createObjectURL","play","error","catch","track","getTracks","stop"],"mappings":"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"}