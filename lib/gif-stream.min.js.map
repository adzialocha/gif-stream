{"version":3,"file":"gif-stream.min.js","sources":["../src/utils/polyfill.js","../src/image.js","../src/upload.js","../src/stream.js"],"sourcesContent":["export default function getUserMediaPolyfill(constraints) {\n  const getUserMedia = (window.navigator.getUserMedia ||\n      window.navigator.webkitGetUserMedia ||\n      window.navigator.mozGetUserMedia ||\n      window.navigator.msGetUserMedia)\n\n  if (!getUserMedia) {\n    return Promise.reject(\n      new Error('getUserMedia is not implemented in this browser')\n    )\n  }\n\n  return new Promise((resolve, reject) => {\n    getUserMedia.call(window.navigator, constraints, resolve, reject)\n  })\n}\n","const DEFAULT_IMAGE_SIZE = 100\nconst IMAGE_QUALITY = 0.8\n\nconst canvas = document.createElement('canvas')\nconst context = canvas.getContext('2d')\n\nexport default function resizedVideostill(video, imageSize = DEFAULT_IMAGE_SIZE) {\n  const videoWidth = video.videoWidth\n  const videoHeight = video.videoHeight\n\n  if (!(videoWidth && videoHeight)) {\n    return 'data:image/jpeg;base64,'\n  }\n\n  canvas.width = imageSize\n  canvas.height = imageSize\n\n  const ratio = videoWidth / videoHeight\n  const targetWidth = imageSize + (imageSize / ratio / 2)\n  const targetHeight = imageSize\n  const xPos = videoWidth > videoHeight ? -(imageSize / ratio / 4) : 0\n  const yPos = videoWidth <= videoHeight ? -(imageSize / ratio / 4) : 0\n\n  context.drawImage(video, xPos, yPos, targetWidth, targetHeight)\n\n  return canvas.toDataURL('image/jpeg', IMAGE_QUALITY)\n}\n","function request(method = 'GET', url, data) {\n  return new Promise((resolve, reject) => {\n    const xhr = new XMLHttpRequest()\n    xhr.open(method, url)\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState === 4) {\n        if (xhr.status === 200) {\n          resolve(JSON.parse(xhr.responseText))\n        } else {\n          reject()\n        }\n      }\n    }\n    xhr.send(data)\n  })\n}\n\nexport default function signAndUploadFile(serverUrl, fileData, id) {\n  request('GET', `${serverUrl}/api/upload?id=${id}`)\n    .then((response) => {\n      request('PUT', response.signedUrl, fileData)\n    })\n}\n","import getUserMediaPolyfill from './utils/polyfill'\nimport resizedVideostill from './image'\nimport signAndUploadFile from './upload'\n\nconst defaultOptions = {\n  callback: () => {},\n  imageSize: 100,\n  interval: 10000,\n  serverUrl: 'http://localhost:3000',\n}\n\nfunction randomId() {\n  return Date.now().toString(36) + Math.random().toString(36).substr(2, 8)\n}\n\nclass GifStream {\n  constructor(customOptions) {\n    this.options = Object.assign({}, defaultOptions, customOptions)\n    this.video = document.createElement('video')\n\n    this.stream = null\n    this.intervalTask = null\n    this.sessionId = ''\n  }\n\n  handleNext() {\n    const imageData = resizedVideostill(this.video, this.options.imageSize)\n    signAndUploadFile(this.options.serverUrl, imageData, this.sessionId)\n\n    this.options.callback({\n      imageData,\n    })\n  }\n\n  start() {\n    if (this.intervalTask) {\n      return Promise.resolve()\n    }\n\n    const constraints = {\n      video: true,\n      audio: false,\n    }\n\n    return new Promise((resolve, reject) => {\n      getUserMediaPolyfill(constraints)\n        .then((stream) => {\n          this.stream = stream\n\n          try {\n            this.video.oncanplay = () => {\n              this.sessionId = randomId()\n              this.intervalTask = setInterval(() => {\n                this.handleNext()\n              }, this.options.interval)\n            }\n            this.video.src = window.URL.createObjectURL(this.stream)\n            this.video.play()\n\n            resolve()\n          } catch (error) {\n            reject(error)\n          }\n        })\n        .catch(reject)\n    })\n  }\n\n  stop() {\n    if (!this.intervalTask) {\n      return\n    }\n\n    const track = this.stream.getTracks()[0]\n    if (track) {\n      track.stop()\n    }\n\n    clearInterval(this.intervalTask)\n    this.intervalTask = null\n    this.sessionId = ''\n  }\n}\n\nexport default GifStream\n"],"names":["getUserMediaPolyfill","constraints","getUserMedia","window","navigator","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","Promise","resolve","reject","call","Error","resizedVideostill","video","imageSize","DEFAULT_IMAGE_SIZE","videoWidth","videoHeight","width","height","ratio","targetWidth","targetHeight","xPos","yPos","drawImage","canvas","toDataURL","IMAGE_QUALITY","request","method","url","data","xhr","XMLHttpRequest","open","onreadystatechange","readyState","status","JSON","parse","responseText","send","signAndUploadFile","serverUrl","fileData","id","then","response","signedUrl","randomId","Date","now","toString","Math","random","substr","document","createElement","context","getContext","defaultOptions","customOptions","options","Object","assign","stream","intervalTask","sessionId","imageData","this","callback","oncanplay","setInterval","handleNext","_this","interval","src","URL","createObjectURL","play","error","catch","track","getTracks","stop"],"mappings":"qLAAe,SAASA,EAAqBC,OACrCC,EAAgBC,OAAOC,UAAUF,cACnCC,OAAOC,UAAUC,oBACjBF,OAAOC,UAAUE,iBACjBH,OAAOC,UAAUG,sBAEhBL,EAME,IAAIM,QAAQ,SAACC,EAASC,KACdC,KAAKR,OAAOC,UAAWH,EAAaQ,EAASC,KANnDF,QAAQE,OACb,IAAIE,MAAM,oDCFhB,SAAwBC,EAAkBC,OAAOC,yDAAYC,EACrDC,EAAaH,EAAMG,WACnBC,EAAcJ,EAAMI,gBAEpBD,IAAcC,QACX,4BAGFC,MAAQJ,IACRK,OAASL,MAEVM,EAAQJ,EAAaC,EACrBI,EAAcP,EAAaA,EAAYM,EAAQ,EAC/CE,EAAeR,EACfS,EAAOP,EAAaC,GAAgBH,EAAYM,EAAQ,EAAK,EAC7DI,EAAOR,GAAcC,GAAgBH,EAAYM,EAAQ,EAAK,WAE5DK,UAAUZ,EAAOU,EAAMC,EAAMH,EAAaC,GAE3CI,EAAOC,UAAU,aAAcC,GCzBxC,SAASC,QAAQC,yDAAS,MAAOC,eAAKC,sBAC7B,IAAIzB,QAAQ,SAACC,EAASC,OACrBwB,EAAM,IAAIC,iBACZC,KAAKL,EAAQC,KACbK,mBAAqB,WACA,IAAnBH,EAAII,aACa,MAAfJ,EAAIK,SACEC,KAAKC,MAAMP,EAAIQ,uBAMzBC,KAAKV,KAIb,SAAwBW,EAAkBC,EAAWC,EAAUC,KACrD,MAAUF,oBAA2BE,GAC1CC,KAAK,SAACC,KACG,MAAOA,EAASC,UAAWJ,KCTzC,SAASK,WACAC,KAAKC,MAAMC,SAAS,IAAMC,KAAKC,SAASF,SAAS,IAAIG,OAAO,EAAG,GFZxE,IAAMzC,EAAqB,IACrBa,EAAgB,GAEhBF,EAAS+B,SAASC,cAAc,UAChCC,EAAUjC,EAAOkC,WAAW,0VEA5BC,YACM,uBACC,aACD,cACC,sDAQCC,kBACLC,QAAUC,OAAOC,UAAWJ,EAAgBC,QAC5CjD,MAAQ4C,SAASC,cAAc,cAE/BQ,OAAS,UACTC,aAAe,UACfC,UAAY,sDAIXC,EAAYzD,EAAkB0D,KAAKzD,MAAOyD,KAAKP,QAAQjD,aAC3CwD,KAAKP,QAAQnB,UAAWyB,EAAWC,KAAKF,gBAErDL,QAAQQ,sEAMTD,KAAKH,oBACA5D,QAAQC,cAGXR,UACG,SACA,UAGF,IAAIO,QAAQ,SAACC,EAASC,KACNT,GAClB+C,KAAK,SAACmB,KACAA,OAASA,QAGPrD,MAAM2D,UAAY,aAChBJ,UAAYlB,MACZiB,aAAeM,YAAY,aACzBC,cACJC,EAAKZ,QAAQa,aAEb/D,MAAMgE,IAAM3E,OAAO4E,IAAIC,gBAAgBJ,EAAKT,UAC5CrD,MAAMmE,WAGX,MAAOC,KACAA,MAGVC,MAAMzE,uCAKN6D,KAAKH,kBAIJgB,EAAQb,KAAKJ,OAAOkB,YAAY,GAClCD,KACIE,qBAGMf,KAAKH,mBACdA,aAAe,UACfC,UAAY"}