{"version":3,"file":"gif-stream.min.js","sources":["../src/image.js","../src/upload.js","../src/stream.js","../src/utils/polyfill.js"],"sourcesContent":["const DEFAULT_IMAGE_SIZE = 100\nconst IMAGE_QUALITY = 0.8\n\nconst canvas = document.createElement('canvas')\nconst context = canvas.getContext('2d')\n\nexport default function resizedVideostill(video, imageSize = DEFAULT_IMAGE_SIZE) {\n  const { videoWidth, videoHeight } = video\n\n  if (!(videoWidth && videoHeight)) {\n    return 'data:image/jpeg;base64,'\n  }\n\n  canvas.width = imageSize\n  canvas.height = imageSize\n\n  const ratio = videoWidth / videoHeight\n  const targetWidth = imageSize + (imageSize / ratio / 2)\n  const targetHeight = imageSize\n  const xPos = videoWidth > videoHeight ? -(imageSize / ratio / 4) : 0\n  const yPos = videoWidth <= videoHeight ? -(imageSize / ratio / 4) : 0\n\n  context.drawImage(video, xPos, yPos, targetWidth, targetHeight)\n\n  return canvas.toDataURL('image/jpeg', IMAGE_QUALITY)\n}\n","function request(method = 'GET', url, body) {\n  return window.fetch(url, {\n    method,\n    body,\n  })\n    .then((response) => {\n      if (!response.ok) {\n        throw new Error(response.statusText)\n      }\n\n      return response.json()\n    })\n}\n\nexport default function signAndUploadFile(serverUrl, fileData, id) {\n  request('GET', `${serverUrl}/api/upload?id=${id}`)\n    .then((response) => {\n      request('PUT', response.signedUrl, fileData)\n    })\n}\n","import getUserMediaPolyfill from './utils/polyfill'\nimport resizedVideostill from './image'\nimport signAndUploadFile from './upload'\n\nconst defaultOptions = {\n  callback: () => {},\n  imageSize: 100,\n  interval: 10000,\n  serverUrl: 'http://localhost:3000',\n}\n\nfunction randomId() {\n  return (9999999999999 - Date.now()) + Math.random().toString(36).substr(2, 3)\n}\n\nclass GifStream {\n  constructor(customOptions) {\n    this.options = Object.assign({}, defaultOptions, customOptions)\n    this.video = document.createElement('video')\n\n    this.stream = null\n    this.intervalTask = null\n    this.sessionId = ''\n  }\n\n  handleNext() {\n    const imageData = resizedVideostill(this.video, this.options.imageSize)\n    signAndUploadFile(this.options.serverUrl, imageData, this.sessionId)\n\n    this.options.callback({\n      imageData,\n    })\n  }\n\n  start() {\n    if (this.intervalTask) {\n      return Promise.resolve()\n    }\n\n    const constraints = {\n      video: true,\n      audio: false,\n    }\n\n    return new Promise((resolve, reject) => {\n      getUserMediaPolyfill(constraints)\n        .then((stream) => {\n          this.stream = stream\n\n          try {\n            this.video.oncanplay = () => {\n              this.sessionId = randomId()\n              this.intervalTask = setInterval(() => {\n                this.handleNext()\n              }, this.options.interval)\n            }\n\n            this.video.srcObject = this.stream\n            this.video.play()\n\n            resolve()\n          } catch (error) {\n            reject(error)\n          }\n        })\n        .catch(reject)\n    })\n  }\n\n  stop() {\n    if (!this.intervalTask) {\n      return\n    }\n\n    const track = this.stream.getTracks()[0]\n    if (track) {\n      track.stop()\n    }\n\n    clearInterval(this.intervalTask)\n    this.intervalTask = null\n    this.sessionId = ''\n  }\n}\n\nexport default GifStream\n","export default function getUserMediaPolyfill(constraints) {\n  if (window.navigator.mediaDevices === undefined) {\n    window.navigator.mediaDevices = {}\n  }\n\n  if (window.navigator.mediaDevices.getUserMedia !== undefined) {\n    return window.navigator.mediaDevices.getUserMedia(constraints)\n  }\n\n  const getUserMedia = (\n    window.navigator.webkitGetUserMedia\n    || window.navigator.mozGetUserMedia\n  )\n\n  if (!getUserMedia) {\n    return Promise.reject(\n      new Error('getUserMedia is not implemented in this browser')\n    )\n  }\n\n  return new Promise((resolve, reject) => {\n    getUserMedia.call(window.navigator, constraints, resolve, reject)\n  })\n}\n"],"names":["canvas","document","createElement","context","getContext","request","method","url","body","window","fetch","then","response","ok","Error","statusText","json","defaultOptions","callback","imageSize","interval","serverUrl","customOptions","options","Object","assign","video","stream","intervalTask","sessionId","imageData","videoWidth","videoHeight","width","ratio","targetWidth","height","targetHeight","xPos","yPos","drawImage","toDataURL","resizedVideostill","this","fileData","id","signedUrl","signAndUploadFile","Promise","resolve","constraints","audio","reject","undefined","navigator","mediaDevices","getUserMedia","webkitGetUserMedia","mozGetUserMedia","call","getUserMediaPolyfill","_this","oncanplay","Date","now","Math","random","toString","substr","setInterval","handleNext","srcObject","play","error","catch","track","getTracks","stop","clearInterval"],"mappings":"qWAAA,IAGMA,EAASC,SAASC,cAAc,UAChCC,EAAUH,EAAOI,WAAW,MCJlC,SAASC,QAAQC,yDAAS,MAAOC,yCAAKC,gDAC7BC,OAAOC,MAAMH,EAAK,CACvBD,OAAAA,EACAE,KAAAA,IAECG,KAAK,SAACC,OACAA,EAASC,SACN,IAAIC,MAAMF,EAASG,mBAGpBH,EAASI,aCNhBC,EAAiB,CACrBC,SAAU,aACVC,UAAW,IACXC,SAAU,IACVC,UAAW,sDAQCC,8GACLC,QAAUC,OAAOC,OAAO,GAAIR,EAAgBK,QAC5CI,MAAQzB,SAASC,cAAc,cAE/ByB,OAAS,UACTC,aAAe,UACfC,UAAY,mGAIXC,EFpBK,SAA2BJ,OAAOP,yDANtB,IAOjBY,EAA4BL,EAA5BK,WAAYC,EAAgBN,EAAhBM,gBAEdD,IAAcC,QACX,0BAGThC,EAAOiC,MAAQd,MAGTe,EAAQH,EAAaC,EACrBG,GAHNnC,EAAOoC,OAASjB,GAGiBA,EAAYe,EAAQ,EAC/CG,EAAelB,EACfmB,EAAoBN,EAAbD,GAA6BZ,EAAYe,EAAQ,EAAK,EAC7DK,EAAOR,GAAcC,GAAgBb,EAAYe,EAAQ,EAAK,SAEpE/B,EAAQqC,UAAUd,EAAOY,EAAMC,EAAMJ,EAAaE,GAE3CrC,EAAOyC,UAAU,aAvBJ,IEyBAC,CAAkBC,KAAKjB,MAAOiB,KAAKpB,QAAQJ,YDZlD,SAA2BE,EAAWuB,EAAUC,GAC7DxC,EAAQ,gBAAUgB,4BAA2BwB,IAC1ClC,KAAK,SAACC,GACLP,EAAQ,MAAOO,EAASkC,UAAWF,KCUrCG,CAAkBJ,KAAKpB,QAAQF,UAAWS,EAAWa,KAAKd,gBAErDN,QAAQL,SAAS,CACpBY,UAAAA,kDAKEa,KAAKf,oBACAoB,QAAQC,cAGXC,EAAc,CAClBxB,OAAO,EACPyB,OAAO,UAGF,IAAIH,QAAQ,SAACC,EAASG,IC5ClB,SAA8BF,WACLG,IAAlC5C,OAAO6C,UAAUC,eACnB9C,OAAO6C,UAAUC,aAAe,SAGiBF,IAA/C5C,OAAO6C,UAAUC,aAAaC,oBACzB/C,OAAO6C,UAAUC,aAAaC,aAAaN,OAG9CM,EACJ/C,OAAO6C,UAAUG,oBACdhD,OAAO6C,UAAUI,uBAGjBF,EAME,IAAIR,QAAQ,SAACC,EAASG,GAC3BI,EAAaG,KAAKlD,OAAO6C,UAAWJ,EAAaD,EAASG,KANnDJ,QAAQI,OACb,IAAItC,MAAM,qDD6BV8C,CAAqBV,GAClBvC,KAAK,SAACgB,GACLkC,EAAKlC,OAASA,MAGZkC,EAAKnC,MAAMoC,UAAY,WACrBD,EAAKhC,UAvCT,cAAgBkC,KAAKC,MAASC,KAAKC,SAASC,SAAS,IAAIC,OAAO,EAAG,GAwC/DP,EAAKjC,aAAeyC,YAAY,WAC9BR,EAAKS,cACJT,EAAKtC,QAAQH,WAGlByC,EAAKnC,MAAM6C,UAAYV,EAAKlC,OAC5BkC,EAAKnC,MAAM8C,OAEXvB,IACA,MAAOwB,GACPrB,EAAOqB,MAGVC,MAAMtB,uCAKNT,KAAKf,kBAIJ+C,EAAQhC,KAAKhB,OAAOiD,YAAY,GAClCD,GACFA,EAAME,OAGRC,cAAcnC,KAAKf,mBACdA,aAAe,UACfC,UAAY"}